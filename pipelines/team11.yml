##############################
########## Settings ##########
##############################

variables:
  CI_CD_DEVELOPMENT_BRANCH: "devBranch"
  CI_CD_TOOL_DEBUG: "true"

##############################
######## DON'T TOUCH #########
##############################

include:
  - project: 'semester-project-e2021/team-12/ci-cd'
    ref: dev
    file: 'base_pipeline.yml'

##############################
############ JOBS ############
##############################

#Build images
build:api_image:
  extends:
    - .build
    - .build_image
  variables:
    CI_CD_IMAGE_NAME: api
    CI_CD_PATH: NodeJS

build:database_image:
  extends:
    - .build
    - .build_image
  variables:
    CI_CD_IMAGE_NAME: database
    CI_CD_PATH: Cassandra

#Run unit tests
#test:unit:
#  image: node:latest
#  extends: .unit
#  script:
#    - cd ./NodeJS/app
#    - npm i
#    - npm test

# test:acceptance:
#   extends: .acceptance
#   needs:
#     - test:unit
#   script:
#     - echo "run acceptance test cmds or script"
#     - echo "run acceptance test cmds or script"

# test:integration:
#   extends: .integration
#   needs:
#     - test:acceptance
#   script:
#     - echo "run integration test cmds or script"
#     - echo "run integration test cmds or script"

# test:performance:
#   extends: .performance
#   needs:
#     - test:integration
#   script:
#     - echo "run performance test cmds or script"
#     - echo "run performance test cmds or script"

### Deliver ###
deploy:kube_api:
  extends:
    - .deploy
    - .kube
  needs:
    - build:api_image
  variables:
    CI_CD_KUBE_FILE: NodeJS/deployment.yaml
    CI_CD_CONTAINER_IMAGES: '[{"container": "t11-api", "image": "api"}]'

deploy:kube_database:
  extends:
    - .deploy
    - .kube
  needs:
    - build:database_image
  variables:
    CI_CD_KUBE_FILE: Cassandra/deployment.yml
    CI_CD_CONTAINER_IMAGES: '[{"container": "t11-cassandra", "image": "database"}]'

### Post ###
cleanup:api_image:
  extends:
    - .cleanup_test_image
    - .remove_test_image_if_exist
  variables:
    # Variables
    #
    # CI_CD_IMAGE_NAME: (string) [Required]
    #
    CI_CD_IMAGE_NAME: api

cleanup:database_image:
  extends:
    - .cleanup_test_image
    - .remove_test_image_if_exist
  variables:
    # Variables
    #
    # CI_CD_IMAGE_NAME: (string) [Required]
    #
    CI_CD_IMAGE_NAME: database