##############################
########## Settings ##########
##############################

variables:
  CI_CD_DEVELOPMENT_BRANCH: "devBranch"
  CI_CD_TOOL_DEBUG: "true"

##############################
######## DON'T TOUCH #########
##############################

include:
  - project: 'semester-project-e2021/team-12/ci-cd'
    ref: v4.0
    file: 'base_pipeline.yml'

##############################
############ JOBS ############
##############################

#Build images
build:api_image:
  extends:
    - .build
    - .build_image
  needs: []
  variables:
    CI_CD_IMAGE_NAME: api
    CI_CD_PATH: NodeJS

build:database_image:
  extends:
    - .build
    - .build_image
  needs: []
  variables:
    CI_CD_IMAGE_NAME: database
    CI_CD_PATH: Cassandra

### Deploy ###
deploy:api:
  extends:
    - .deploy
    - .kube
  needs:
    - build:api_image
    - job: setup:state
      optional: true
  variables:
    CI_CD_KUBE_FILE: NodeJS/deployment.yaml
    CI_CD_CONTAINER_IMAGES: '[{"type": "Deployment", "container": "t11-api", "image": "api"}]'

deploy:database:
  extends:
    - .deploy
    - .kube
  needs:
    - build:database_image
    - job: setup:state
      optional: true
  variables:
    CI_CD_KUBE_FILE:  Cassandra/deploy-cass.yml
    CI_CD_CONTAINER_IMAGES: '[{"type": "StatefulSet", "container": "t11-cassandra", "image": "database"}]'

deploy:db_service:
  extends:
    - .deploy
    - .kube
  needs:
    - deploy:database
  variables:
    CI_CD_KUBE_FILE:  Cassandra/service.yml

### Post ###
cleanup:api_image:
  extends:
    - .cleanup_test_image
    - .remove_test_image_if_exist
  variables:
    # Variables
    #
    # CI_CD_IMAGE_NAME: (string) [Required]
    #
    CI_CD_IMAGE_NAME: api

cleanup:database_image:
  extends:
    - .cleanup_test_image
    - .remove_test_image_if_exist
  variables:
    # Variables
    #
    # CI_CD_IMAGE_NAME: (string) [Required]
    #
    CI_CD_IMAGE_NAME: database