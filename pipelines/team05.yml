##############################
######## DON'T TOUCH #########
##############################

include:
  - project: semester-project-e2021/team-12/ci-cd
    ref: v2.0.2
    file: base_pipeline.yml

variables:
  CI_CD_PRODUCTION_IMAGE_PRE: "production/"

##############################
############ Jobs ############
##############################
### Build ###
build:fluent:
  extends:
    - .build
    - .build_image
  needs: []
  variables:
    CI_CD_IMAGE_NAME: fluent
    CI_CD_PATH: Docker/fluent

build:api:
  extends:
    - .build
    - .build_image
  needs: []
  variables:
    CI_CD_IMAGE_NAME: api
    CI_CD_PATH: Docker/api

build:visualization:
  extends:
    - .build
    - .build_image
  needs: []
  variables:
    CI_CD_IMAGE_NAME: visualization
    CI_CD_PATH: Docker/kibana_visualization

build:home:
  extends:
    - .build
    - .build_image
  needs: []
  variables:
    CI_CD_IMAGE_NAME: home
    CI_CD_PATH: Docker/home

### Deploy ###
deploy:elasticsearch_statefulset:
  extends:
    - .deploy
    - .kube
  needs:
    - job: setup:state
      optional: true
  variables:
    CI_CD_KUBE_FILE: kubernetes/elasticsearch_statefulset.yml

deploy:mongo:
  extends:
    - .deploy
    - .kube
  needs:
    - deploy:elasticsearch_statefulset
  variables:
    CI_CD_KUBE_FILE: kubernetes/mongo.yml

deploy:kibana:
  extends:
    - .deploy
    - .kube
  needs:
    - deploy:mongo
  variables:
    CI_CD_KUBE_FILE: kubernetes/kibana.yml

deploy:fluentd_config:
  extends:
    - .deploy
    - .kube
  needs:
    - deploy:kibana
  variables:
    CI_CD_KUBE_FILE: kubernetes/fluentd-config.yml

deploy:fluentd:
  extends:
    - .deploy
    - .kube
  needs:
    - build:fluent
    - deploy:fluentd_config
  variables:
    CI_CD_KUBE_FILE: kubernetes/fluentd-deployment.yml
    CI_CD_CONTAINER_IMAGES: '[{"container": "t05-fluentd", "image": "fluentd"}]'

deploy:api:
  extends:
    - .deploy
    - .kube
  needs:
    - build:api
    - deploy:fluentd
  variables:
    CI_CD_KUBE_FILE: kubernetes/api.yml
    CI_CD_CONTAINER_IMAGES: '[{"container": "t05-api", "image": "api"}]'

deploy:visualisation:
  extends:
    - .deploy
    - .kube
  needs:
    - build:visualization
    - deploy:api
  variables:
    CI_CD_KUBE_FILE: kubernetes/visualization.yml
    CI_CD_CONTAINER_IMAGES: '[{"container": "t05-visualization", "image": "visualization"}]'

deploy:home:
  extends:
    - .deploy
    - .kube
  needs:
    - build:home
    - deploy:visualisation
  variables:
    CI_CD_KUBE_FILE: kubernetes/home.yml
    CI_CD_CONTAINER_IMAGES: '[{"container": "t05-home", "image": "home"}]'

deploy:status:
  extends:
    - .deploy
    - .rollout_status
    - .merge_request_production
  needs:
    - deploy:home
  variables:
    CI_CD_DEPLOYMENT_NAMES: "t05-es-cluster t05-mongodb t05-kibana t05-fluentd-config t05-fluentd t05-api t05-visualization t05-home"

### Test ###
test:integration:
  extends: .integration
  needs:
    - deploy:status
  script:
    - echo "run integration test cmds or script"

### Post ###
cleanup:fluent:
  extends:
    - .cleanup_test_image
    - .remove_test_image_if_exist
  variables:
    CI_CD_IMAGE_NAME: fluent

cleanup:api:
  extends:
    - .cleanup_test_image
    - .remove_test_image_if_exist
  variables:
    CI_CD_IMAGE_NAME: api

cleanup:visualization:
  extends:
    - .cleanup_test_image
    - .remove_test_image_if_exist
  variables:
    CI_CD_IMAGE_NAME: visualization

cleanup:home:
  extends:
    - .cleanup_test_image
    - .remove_test_image_if_exist
  variables:
    CI_CD_IMAGE_NAME: home
