##############################
######## DON'T TOUCH #########
##############################

include:
  - project: semester-project-e2021/team-12/ci-cd
    ref: v4.0.0
    file: base_pipeline.yml

##############################
############ Jobs ############
##############################

### Build ###
build:api:
  extends:
    - .build
    - .build_image
    - .except_development
  needs: []
  variables:
    # Variables
    #
    # CI_CD_IMAGE_NAME: (string) [Required]
    # CI_CD_FILE_NAME: (string) [Optional]
    #   Default: Dockerfile
    # CI_CD_PATH: (string) [Optional]
    #   Default: .
    #
    CI_CD_IMAGE_NAME: api

### Deploy ###
deploy:api:
  extends:
    - .deploy
    - .kube
  needs:
    - job: setup:state
      optional: true
    - build:api
  variables:
  #Variables
     
     #CI_CD_KUBE_FILE: (string) [Required]
     #CI_CD_CONTAINER_IMAGES: (json) [Required]
#     #   E.g.
#     #     [
#     #       {"container": "t12-api", "image": "api"},
#     #       {"container": "t12-database", "image": "database"}
#     #     ]
#     #
    CI_CD_KUBE_FILE: api.yaml
    CI_CD_CONTAINER_IMAGES: '[{"type": "Deployment", "container": "t01-api", "image", "api"}]'


### Test ###
test:unit:
  image: 
    name: python:3.10-alpine3.14
    entrypoint: ["/bin/sh"]
  needs: []
  extends: .unit
  script:
    - pwd
    - ls -l 
    - cd ${CI_BUILDS_DIR}/${CI_PROJECT_PATH}
    - ls -l
    - pip install -U flask
    - flask test



### Post ###
cleanup:api:
  extends:
    - .cleanup_test_image
    - .remove_test_image_if_exist
    - .always_merge_request_production
  variables:
    # Variable
    #
    # CI_CD_IMAGE_NAME: (string) [Required]
    #
    CI_CD_IMAGE_NAME: api
