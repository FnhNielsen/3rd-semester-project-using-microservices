include:
  - project: semester-project-e2021/team-12/ci-cd
    ref: main
    file: base_pipeline.yml

### Build ###
build:aam:
  extends:
    - .build
    - .build_image
  variables:
    CI_CD_IMAGE_NAME: aam
    CI_CD_DOCKER_PATH:  AAM_Service/api

build:ads:
  extends:
    - .build
    - .build_image
  variables:
    CI_CD_IMAGE_NAME: ads
    CI_CD_DOCKER_PATH: Ads_Service/api

build:audience_targeting:
  extends:
    - .build
    - .build_image
  variables:
    CI_CD_IMAGE_NAME: audience_targeting
    CI_CD_DOCKER_PATH: Audience_Targeting_Service/api

build:billing:
  extends:
    - .build
    - .build_image
  variables:
    CI_CD_IMAGE_NAME: billing
    CI_CD_DOCKER_PATH: Billing_Service/api

### Deliver ###
deploy:kube_mongo:
    extends:
      - .deploy
      - .kube
    variables:
        CI_CD_KUBE_FILE: mongo_deployment.yml
        CI_CD_CONTAINER_IMAGES: '[{"container": "t14-database"}]'

deploy:kube_aam:
    extends:
      - .deploy
      - .kube
    variables:
        CI_CD_KUBE_FILE: aam_deployment.yml
        CI_CD_CONTAINER_IMAGES: '[{"container": "t14-aam-service"}]'

deploy:status:
  extends:
    - .rollout_status
    - .merge_request_production
  needs:
    - deploy:kube_mongo
    - deploy:kube_aam
  variables:
    CI_CD_DEPLOYMENT_NAMES: "t14-database t14-aam"
  timeout: 2 minutes

### Post ###
cleanup:aam_image:
  extends:
    - .delete_test_image
    - .remove_test_image_if_exist
  variables:
    CI_CD_IMAGE_NAME: aam

cleanup:ads_image:
  extends:
    - .delete_test_image
    - .remove_test_image_if_exist
  variables:
    CI_CD_IMAGE_NAME: ads

cleanup:audience_targeting_image:
  extends:
    - .delete_test_image
    - .remove_test_image_if_exist
  variables:
    CI_CD_IMAGE_NAME: audience_targeting

cleanup:billing_image:
  extends:
    - .delete_test_image
    - .remove_test_image_if_exist
  variables:
    CI_CD_IMAGE_NAME: billing
