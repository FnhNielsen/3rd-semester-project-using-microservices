include:
  - project: semester-project-e2021/team-12/ci-cd
    ref: v3.0
    file: base_pipeline.yml

### Build ###
build:aam:
  extends:
    - .build
    - .build_image
  variables:
    CI_CD_IMAGE_NAME: aam
    CI_CD_PATH:  AAM_Service/api/

build:ads:
  extends:
    - .build
    - .build_image
  variables:
    CI_CD_IMAGE_NAME: ads
    CI_CD_PATH: Ads_Service/api/

build:audience_targeting:
  extends:
    - .build
    - .build_image
  variables:
    CI_CD_IMAGE_NAME: audience_targeting
    CI_CD_PATH: Audience_Targeting_Service/api/

build:billing:
  extends:
    - .build
    - .build_image
  variables:
    CI_CD_IMAGE_NAME: billing
    CI_CD_PATH: Billing_Service/api/

build:client:
  extends:
    - .build
    - .build_image
  variables:
    CI_CD_IMAGE_NAME: client
    CI_CD_PATH: AAM_Service/client/

build:database:
  extends:
    - .build
    - .build_image
  variables:
    CI_CD_IMAGE_NAME: database
    CI_CD_PATH: database/

### Deliver ###
deploy:kube_mongo:
    extends:
      - .deploy
      - .kube
    variables:
        CI_CD_KUBE_FILE: mongo_deployment.yml
        CI_CD_CONTAINER_IMAGES: '[{"container": "t14-database", "image": "database"}]'

deploy:kube_aam:
    extends:
      - .deploy
      - .kube
    needs:
      - deploy:kube_mongo
    variables:
        CI_CD_KUBE_FILE: aam_deployment.yml
        CI_CD_CONTAINER_IMAGES: '[{"container": "t14-aam-service", "image": "aam"}]'

deploy:kube_ads:
    extends:
      - .deploy
      - .kube
    needs:
      - deploy:kube_mongo
    variables:
        CI_CD_KUBE_FILE: ads_deployment.yml
        CI_CD_CONTAINER_IMAGES: '[{"container": "t14-ads", "image": "ads"}]'

deploy:kube_audience_targeting:
    extends:
      - .deploy
      - .kube
    needs:
      - deploy:kube_mongo
    variables:
        CI_CD_KUBE_FILE: at_deployment.yml
        CI_CD_CONTAINER_IMAGES: '[{"container": "t14-at", "image": "audience_targeting"}]'

deploy:kube_billing:
    extends:
      - .deploy
      - .kube
    needs:
      - deploy:kube_mongo
    variables:
        CI_CD_KUBE_FILE: billing_deployment.yml
        CI_CD_CONTAINER_IMAGES: '[{"container": "t14-billing", "image": "billing"}]'

deploy:kube_client:
    extends:
      - .deploy
      - .kube
    needs:
      - deploy:kube_mongo
      - deploy:kube_audience_targeting
      - deploy:kube_ads
      - deploy:kube_aam
      - deploy:kube_mongo
      - deploy:kube_billing
    variables:
        CI_CD_KUBE_FILE: client_deployment.yml
        CI_CD_CONTAINER_IMAGES: '[{"container": "t14-client", "image": "client"}]'

deploy:status:
  extends:
    - .deploy
    - .rollout_status
    - .merge_request_production
  needs:
    - deploy:kube_mongo
    - deploy:kube_aam
  variables:
    CI_CD_CHECK_STATUS: '[
        {"type": "deployment", "name": "t14-database"},
        {"type": "deployment", "name": "t14-aam"},
        {"type": "deployment", "name": "t14-at"},
        {"type": "deployment", "name": "t14-client"},
        {"type": "deployment", "name": "t14-billing"},
        {"type": "deployment", "name": "t14-ads"}]'

deploy:failure:
  extends:
    - .deploy
    - .rollout_fail
    - .on_failure_request_production
  needs:
    - deploy:status
  variables:
    CI_CD_DEPLOYMENT_FILES: "mongo_deployment.yml aam_deployment.yml ads_deployment.yml at_deployment.yml client_deployment.yml billing_deployment.yml"

### Post ###
cleanup:aam_image:
  extends:
    - .cleanup_test_image
    - .remove_test_image_if_exist
  variables:
    CI_CD_IMAGE_NAME: aam

cleanup:ads_image:
  extends:
    - .cleanup_test_image
    - .remove_test_image_if_exist
  variables:
    CI_CD_IMAGE_NAME: ads

cleanup:audience_targeting_image:
  extends:
    - .cleanup_test_image
    - .remove_test_image_if_exist
  variables:
    CI_CD_IMAGE_NAME: audience_targeting

cleanup:billing_image:
  extends:
    - .cleanup_test_image
    - .remove_test_image_if_exist
  variables:
    CI_CD_IMAGE_NAME: billing

cleanup:database_image:
  extends:
    - .cleanup_test_image
    - .remove_test_image_if_exist
  variables:
    CI_CD_IMAGE_NAME: database

cleanup:client_image:
  extends:
    - .cleanup_test_image
    - .remove_test_image_if_exist
  variables:
    CI_CD_IMAGE_NAME: client
