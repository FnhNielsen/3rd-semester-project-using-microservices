include:
  - project: semester-project-e2021/team-12/ci-cd
    ref: v5.0
    file: base_pipeline.yml


variables:
  CI_CD_PRODUCTION_IMAGE_PRE: "prod-"
##############################
############ JOBS ############
##############################

#Builds mailService image
build:mailService:
    extends: 
      - .build 
      - .build_image
    needs: []
    variables: 
         CI_CD_IMAGE_NAME: 'mailService' 
         CI_CD_PATH: 'dockerfiles/mailserviceDocker'


#Builds subscriptionService image
build:subscriptionService:
    extends: 
      - .build 
      - .build_image
    needs: []
    variables: 
         CI_CD_IMAGE_NAME: 'subscriptionService'
         CI_CD_PATH: 'dockerfiles/subscriptionserviceDocker'


#Run unit tests
test:unit:
  image:
    - openjdk:17
    - gradle:7.2.0-jdk17
  extends: .unit
  script:
    - gradle test

# depliver
deploy:mailService:
  extends:
    - .deploy
    - .kube
  variables:
    CI_CD_KUBE_FILE: /manifest.yml
    CI_CD_CONTAINER_IMAGES: '[{"container": "t04-mailService", "image": "mailService"}]'

deploy:subscriptionService:
  extends:
    - .deploy
    - .kube
  variables:
    CI_CD_KUBE_FILE: /manifest.yml
    CI_CD_CONTAINER_IMAGES: '[{"container": "t04-subscription", "image": "subscriptionService"}]'

    
status:monitor_containers:
  extends:
    - .deploy
    - .kube_monitor
  needs:
    - deploy:mailService
    - deploy:subscriptionService
  variables:
    # Variables
    #
    # CI_CD_KUBE_FILES: (string) [Required]
    #   E.g. Only one file
    #     kube/api.yml
    #   E.g. Multiple files at once
    #     kube/api.yml kube/database.yml
    # CI_CD_TIME: (string) [Optional]
    #   E.g. 10m or 100s
    #
    CI_CD_KUBE_FILES: "/manifest.yml"

status:resource_consumption:
  extends:
    - .deploy
    - .kube_top
  needs:
    - deploy:subscriptionService
    - deploy:mailService
  variables:
    # Variable
    #
    # CI_CD_KUBE_FILES: (string) [Required]
    #   E.g. Only one file
    #     kube/api.yml
    #   E.g. Multiple files at once
    #     kube/api.yml kube/database.yml
    #
    CI_CD_KUBE_FILES: "/manifest.yml"



### Post ###
cleanup:mailService:
  extends:
    - .cleanup
    - .remove_test_image_if_exist
  variables:
    CI_CD_IMAGE_NAME: mailService

cleanup:subscriptionService:
  extends:
    - .cleanup
    - .remove_test_image_if_exist
  variables:
    CI_CD_IMAGE_NAME: subscriptionService

cleanup:stage_env:
  extends:
    - .cleanup
    - .always_merge_request_production
    - .kube_delete
  variables:
    # Variable
    #
    # CI_CD_KUBE_FILES: (string) [Required]
    #   E.g. Only one file
    #     kube/api.yml
    #   E.g. Multiple files at once
    #     kube/common.yaml kube/api.yml kube/database.yml
    #
    CI_CD_KUBE_FILES: "/manifest.yml"