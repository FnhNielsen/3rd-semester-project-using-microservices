include:
  - project: semester-project-e2021/team-12/ci-cd
    ref: v5.0
    file: base_pipeline.yml

##############################
############ JOBS ############
##############################

#Builds mailService image
build:mailService:
    extends: 
      - .build 
      - .build_image
    variables: 
         CI_CD_IMAGE_NAME: 'mailService' 
         CI_CD_PATH: 'dockerfiles/mailserviceDocker'


#Builds subscriptionService image
build:subscriptionService:
    extends: 
      - .build 
      - .build_image
    variables: 
         CI_CD_IMAGE_NAME: 'subscriptionService'
         CI_CD_PATH: 'dockerfiles/subscriptionserviceDocker'


#Run unit tests
test:unit:
  image:
    - openjdk:17
    - gradle:7.2.0-jdk17
  extends: .unit
  script:
    - gradle test

# depliver
deploy:mailService:
  extends:
    - .deploy
    - .kube
  variables:
    CI_CD_KUBE_FILE: /manifest.yml
    CI_CD_CONTAINER_IMAGES: '[{"container": "t04-mailService", "image": "mailService"}]'

deploy:subscriptionService:
  extends:
    - .deploy
    - .kube
  variables:
    CI_CD_KUBE_FILE: /manifest.yml
    CI_CD_CONTAINER_IMAGES: '[{"container": "t04-subscription", "image": "subscriptionService"}]'

deploy:status:
  extends:
    - .deploy
    - .rollout_status
    - .merge_request_production
  needs:
      - deploy:mailService
      - deploy:subscriptionService
  variables:
    CI_CD_CHECK_STATUS: '[
        {"type": "deployment", "name": "t04-mailService"},
        {"type": "deployment", "name": "t04-subscription"}]'

deploy:failure:
  extends:
    - .deploy
    - .rollout_fail
    - .on_failure_request_production
  needs:
    - deploy:status
  variables:
      CI_CD_DEPLOYMENT_FILES: "/manifest.yml"



### Post ###
cleanup:mailService:
  extends:
    - .cleanup_test_image
    - .remove_test_image_if_exist
  variables:
    CI_CD_IMAGE_NAME: mailService

cleanup:subscriptionService:
  extends:
    - .cleanup_test_image
    - .remove_test_image_if_exist
  variables:
    CI_CD_IMAGE_NAME: subscriptionService