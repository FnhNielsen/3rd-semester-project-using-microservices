##############################
########## Settings ##########
##############################

variables:
  CI_CD_PRODUCTION_BRANCH: "main"
  CI_CD_DEVELOPMENT_BRANCH: "dev"
  CI_CD_RELEASE_BRANCH: "release"
  CI_CD_HOTFIX_BRANCH: "hotfix"

##############################
######## DON'T TOUCH #########
##############################

include:
  - project: 'semester-project-e2021/team-12/ci-cd'
    ref: dev
    file: 'base_pipeline.yml'

##############################
############ Jobs ############
##############################
### Build ###
build:compile:
  extends:
    - .build
    - .artifact
  script:
    - echo "compiling"
    - echo "compiling"

build:images:
  extends:
    - .build
    - .test_images
  needs:
    - build:compile
  variables:
    # variables
    #
    # CI_CD_BUILD_ARGS: (string or JSON)
    #   Different examples of building the same image.
    #    * image_name
    #    * '{"name": "image_name", "path": "."}'
    #    * '{"name": "image_name", "path": ".", "file": "Dockerfile"}'
    #    * '["image_name"]'
    #    * '["image_name", "."]'
    #    * '["image_name", ".", "Dockerfile"]'
    #
    #   Several images at once
    #    '[
    #       {"name": "image_name"},
    #       {"name": "image_name_2", "file": "Dockerfile_2"},
    #       ["image_name_3", "image_name_path_3"]
    #    ]'
    #
    CI_CD_BUILD_ARGS: '[
      {"name": "api", "path": "api"}
    ]'

### Test ###
test:unit:
  extends: .unit
  needs:
    - build:image
  script:
    - echo "run unit test cmds or script"
    - echo "run unit test cmds or script"

test:acceptance:
  extends: .acceptance
  needs:
    - test:unit
  script:
    - echo "run acceptance test cmds or script"
    - echo "run acceptance test cmds or script"

test:integration:
  extends: .integration
  needs:
    - test:acceptance
  script:
    - echo "run integration test cmds or script"
    - echo "run integration test cmds or script"

test:performance:
  extends: .performance
  needs:
    - test:integration
  script:
    - echo "run performance test cmds or script"
    - echo "run performance test cmds or script"

### Deliver ###
deliver:retag_images:
  extends:
    - .deliver
    - .production_images
  variables:
    # variables
    #
    # CI_CD_IMAGE_NAMES: (string)
    #   Single image
    #    * image_name
    #   Several images at once
    #    * image_name_1 image_name_2 image_name_3 ...
    #
    CI_CD_IMAGE_NAMES: api

### Cleanup ###
finish:remove_test_images:
  extends:
    - .finish
    - .remove_test_images
  variables:
    # variables
    #
    # CI_CD_IMAGE_NAMES: (string)
    #   Single image
    #    * image_name
    #   Several images at once
    #    * image_name_1 image_name_2 image_name_3 ...
    #
    CI_CD_IMAGE_NAMES: api
